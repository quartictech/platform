machine:
  java:
    version: openjdk8
  services:
    - docker

dependencies:
  cache_directories:
    - .gradle
    - weyl-frontend/.gradle/nodejs
    - management-frontend/.gradle/nodejs
    - weyl-frontend/node_modules
    - management-frontend/node_modules
  override:
    - ./gradlew resolveConfigurations npmInstall --parallel --info --console=plain

test:
  override:
    # We don't run --parallel because of Kotlin compiler bugs (see e.g. https://youtrack.jetbrains.com/issue/KT-10028)
    - ./gradlew check --info --console=plain --profile
  post:
    - mkdir -p ${CIRCLE_TEST_REPORTS}/junit/
    - find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} ${CIRCLE_TEST_REPORTS}/junit/ \;

deployment:
  hub:
    branch: /.*/
    commands:
      - curl https://raw.githubusercontent.com/quartictech/circleci-utils/develop/circleci-gcloud-login | bash
      - ./gradlew dockerPush --parallel --info --console=plain
